<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precise DS Engine - Safe Mode</title>
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --primary: #58a6ff;
            --accent: #7ee787;
            --danger: #f85149;
            --text: #c9d1d9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 450px; }

        .engine-card {
            background: var(--card);
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .status-pill {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            background: #21262d;
            border: 1px solid #30363d;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .safe-indicator {
            font-size: 0.65rem;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .prediction-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .pred-box {
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 12px;
            padding: 15px 5px;
            transition: 0.3s;
        }

        .pred-box.active { border-color: var(--accent); background: rgba(126, 231, 135, 0.1); }
        .pred-box .val { font-size: 2.2rem; font-weight: 800; color: #fff; display: block; }
        .pred-box .label { font-size: 0.6rem; color: #8b949e; text-transform: uppercase; }

        .input-group { display: flex; gap: 8px; margin: 20px 0; }
        .bulk-input { flex: 1; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 12px; color: white; }
        
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-load { background: var(--primary); color: #0d1117; }
        .btn-clr { background: var(--danger); color: white; margin-left: 5px; }

        .numpad { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .num-btn { aspect-ratio: 1; background: #21262d; border: 1px solid #30363d; color: white; font-weight: bold; border-radius: 6px; cursor: pointer; }
        .num-btn:active { background: var(--primary); }

        .history-list { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 6px; }
        .h-item { background: #30363d; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="engine-card">
            <div id="status" class="status-pill">AWAITING DATA</div>
            
            <div id="safeStatus" class="safe-indicator" style="color: #8b949e;">SAFE MODE: ACTIVE (REQ. 2 MATCHES)</div>

            <div class="prediction-row">
                <div class="pred-box" id="p1"><span class="label">DS 1</span><span class="val">-</span></div>
                <div class="pred-box" id="p2"><span class="label">DS 2</span><span class="val">-</span></div>
                <div class="pred-box" id="p3"><span class="label">DS 3</span><span class="val">-</span></div>
            </div>

            <div style="font-size:0.8rem; border-top:1px solid #333; padding-top:10px;">
                Pattern: <span id="seqText" style="color:var(--accent)">---</span> | Matches Found: <span id="matchCount" style="color:white">0</span>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="bulk" class="bulk-input" placeholder="Paste history here...">
            <button id="loadBtn" class="btn btn-load">LOAD</button>
            <button id="clrBtn" class="btn btn-clr">CLR</button>
        </div>

        <div class="numpad" id="numpad"></div>
        <div class="history-list" id="history"></div>
    </div>

    <script>
        let history = [];

        function getDS(n) { return n === 0 ? 0 : Math.ceil(n / 6); }

        function initPad() {
            const pad = document.getElementById('numpad');
            for(let i=0; i<=36; i++) {
                const b = document.createElement('button');
                b.className = 'num-btn'; b.textContent = i;
                b.onclick = () => { history.push(i); process(); };
                pad.appendChild(b);
            }
        }

        function process() {
            const histDiv = document.getElementById('history');
            histDiv.innerHTML = history.slice(-15).map(n => `<span class="h-item">${n}</span>`).join('');

            if (history.length < 4) return;

            const dsHistory = history.map(getDS);
            const pattern = dsHistory.slice(-3); 
            document.getElementById('seqText').textContent = pattern.join('â†’');

            let frequencyMap = {};
            let totalPatternMatches = 0;

            // SCAN ENTIRE HISTORY
            // We search until length - 4 to ensure there is a number after the pattern to record
            for (let i = 0; i <= dsHistory.length - 4; i++) {
                if (dsHistory[i] === pattern[0] && 
                    dsHistory[i+1] === pattern[1] && 
                    dsHistory[i+2] === pattern[2]) {
                    
                    totalPatternMatches++;
                    
                    // Grab the next DS result
                    let result = dsHistory[i+3];
                    frequencyMap[result] = (frequencyMap[result] || 0) + 1;
                }
            }

            document.getElementById('matchCount').textContent = totalPatternMatches;

            // SAFE MODE LOGIC: Check if total matches >= 2
            if (totalPatternMatches >= 2) {
                let sorted = Object.keys(frequencyMap)
                    .sort((a, b) => frequencyMap[b] - frequencyMap[a])
                    .slice(0, 3);
                updateUI(true, sorted);
            } else {
                updateUI(false, []);
            }
        }

        function updateUI(isSafe, data) {
            const status = document.getElementById('status');
            const safeStatus = document.getElementById('safeStatus');
            const boxes = [document.getElementById('p1'), document.getElementById('p2'), document.getElementById('p3')];
            
            if (isSafe && data.length > 0) {
                status.textContent = "SAFE MATCH FOUND";
                status.style.color = "var(--accent)";
                safeStatus.textContent = "SAFE MODE: SIGNAL STABLE";
                safeStatus.style.color = "var(--accent)";
                
                boxes.forEach((box, i) => {
                    const valSpan = box.querySelector('.val');
                    if (data[i] !== undefined) {
                        valSpan.textContent = data[i];
                        box.classList.add('active');
                    } else {
                        valSpan.textContent = "?";
                        box.classList.remove('active');
                    }
                });
            } else {
                status.textContent = isSafe ? "NO DATA AFTER MATCH" : "INSUFFICIENT DATA";
                status.style.color = "var(--primary)";
                safeStatus.textContent = isSafe ? "WAITING FOR DATA" : "SAFE MODE: WAITING FOR 2nd MATCH";
                safeStatus.style.color = "var(--danger)";
                boxes.forEach(b => { b.querySelector('.val').textContent = "-"; b.classList.remove('active'); });
            }
        }

        document.getElementById('loadBtn').onclick = () => {
            const raw = document.getElementById('bulk').value;
            const nums = raw.split(/[ ,]+/).map(n => parseInt(n)).filter(n => !isNaN(n));
            history = [...history, ...nums];
            process();
            document.getElementById('bulk').value = '';
        };

        document.getElementById('clrBtn').onclick = () => {
            history = [];
            document.getElementById('seqText').textContent = "---";
            document.getElementById('matchCount').textContent = "0";
            process();
        };

        window.onload = initPad;
    </script>
</body>
</html>
