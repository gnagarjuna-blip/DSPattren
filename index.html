<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Exact History Matcher</title>
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --primary: #58a6ff;
            --accent: #7ee787;
            --warning: #d29922;
            --danger: #f85149;
            --text: #c9d1d9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; }
        .container { max-width: 500px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 20px; }
        h1 { color: var(--primary); font-size: 1.5rem; letter-spacing: 1px; }

        .engine-card {
            background: var(--card);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-pill {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
            background: #21262d;
            border: 1px solid #30363d;
            margin-bottom: 15px;
        }

        .status-pill.match {
            color: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(126, 231, 135, 0.2);
        }

        .prediction-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .pred-box {
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 10px;
            padding: 15px 5px;
        }

        .pred-box.active { border-color: var(--accent); background: rgba(126, 231, 135, 0.05); }
        .pred-box .val { font-size: 2rem; font-weight: 800; color: white; display: block; }
        .pred-box .label { font-size: 0.6rem; color: #8b949e; text-transform: uppercase; }

        .sequence-info {
            font-size: 0.8rem;
            color: #8b949e;
            padding-top: 10px;
            border-top: 1px solid #30363d;
        }

        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .bulk-input { 
            flex: 1; background: #0d1117; border: 1px solid #30363d; 
            border-radius: 6px; padding: 10px; color: white; 
        }
        
        .btn { padding: 10px 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-load { background: var(--primary); color: #0d1117; }
        .btn-clr { background: var(--danger); color: white; }

        .numpad {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px;
            background: var(--card); padding: 10px; border-radius: 12px;
        }
        .num-btn {
            aspect-ratio: 1; background: #21262d; border: 1px solid #30363d;
            color: white; font-weight: bold; border-radius: 4px; cursor: pointer;
        }
        .num-btn.zero { background: #238636; }
        .num-btn:active { background: var(--primary); }

        .history-list {
            margin-top: 15px; display: flex; flex-wrap: wrap; gap: 5px;
            max-height: 80px; overflow-y: auto;
        }
        .h-item { background: #30363d; padding: 2px 8px; border-radius: 3px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>DS EXACT MATCHER</h1></header>

        <div class="engine-card">
            <div id="status" class="status-pill">Wait for 3+ Spins</div>
            
            <div class="prediction-row">
                <div class="pred-box" id="p1"><span class="label">Next DS 1</span><span class="val">-</span></div>
                <div class="pred-box" id="p2"><span class="label">Next DS 2</span><span class="val">-</span></div>
                <div class="pred-box" id="p3"><span class="label">Next DS 3</span><span class="val">-</span></div>
            </div>

            <div class="sequence-info">
                Current Pattern: <span id="seqText" style="color:white; font-weight:bold;">---</span>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="bulk" class="bulk-input" placeholder="Paste numbers...">
            <button id="loadBtn" class="btn btn-load">LOAD</button>
            <button id="clrBtn" class="btn btn-clr">CLR</button>
        </div>

        <div class="numpad" id="numpad"></div>
        <div class="history-list" id="history"></div>
    </div>

    <script>
        let history = [];

        function getDS(n) {
            if (n === 0) return 0;
            return Math.ceil(n / 6);
        }

        function initPad() {
            const pad = document.getElementById('numpad');
            const z = document.createElement('button');
            z.className = 'num-btn zero'; z.textContent = '0';
            z.onclick = () => addNum(0);
            pad.appendChild(z);
            for(let i=1; i<=36; i++) {
                const b = document.createElement('button');
                b.className = 'num-btn'; b.textContent = i;
                b.onclick = () => addNum(i);
                pad.appendChild(b);
            }
        }

        function addNum(n) {
            history.push(n);
            process();
        }

        function process() {
            const histDiv = document.getElementById('history');
            histDiv.innerHTML = history.slice(-20).map(n => `<span class="h-item">${n}</span>`).join('');

            if (history.length < 4) return;

            const dsHistory = history.map(getDS);
            const last3 = dsHistory.slice(-3);
            document.getElementById('seqText').textContent = last3.join(' â†’ ');

            let resultDS = [];
            let matchFound = false;

            // Search history backwards to find the LATEST exact match of the pattern
            // Start searching at (length - 4) so we don't match the current live sequence itself
            for (let i = dsHistory.length - 4; i >= 0; i--) {
                if (dsHistory[i] === last3[0] && 
                    dsHistory[i+1] === last3[1] && 
                    dsHistory[i+2] === last3[2]) {
                    
                    matchFound = true;
                    
                    // Match found! Now look at the results that followed it
                    // Start from the very first DS after the pattern (i + 3)
                    // We look through all historical data up to the current sequence
                    for (let j = i + 3; j < dsHistory.length - 3; j++) {
                        let candidate = dsHistory[j];
                        
                        // Rule: Add only if it's unique (not already in our 3 results)
                        if (!resultDS.includes(candidate)) {
                            resultDS.push(candidate);
                        }
                        
                        // Stop immediately when we have exactly 3 unique results
                        if (resultDS.length === 3) break;
                    }
                    
                    // If this latest match didn't have 3 unique results after it,
                    // you might want to keep searching for an older match.
                    // But as per your request, we stop at the latest match.
                    break; 
                }
            }

            render(matchFound, resultDS);
        }

        function render(isMatch, data) {
            const status = document.getElementById('status');
            const boxes = [document.getElementById('p1'), document.getElementById('p2'), document.getElementById('p3')];
            
            if (isMatch) {
                status.textContent = "HISTORICAL MATCH FOUND";
                status.className = "status-pill match";
                boxes.forEach((box, i) => {
                    const valSpan = box.querySelector('.val');
                    if (data[i] !== undefined) {
                        valSpan.textContent = data[i];
                        box.classList.add('active');
                    } else {
                        valSpan.textContent = "?"; // Shown if match has < 3 unique following results
                        box.classList.remove('active');
                    }
                });
            } else {
                status.textContent = "SEARCHING HISTORY...";
                status.className = "status-pill";
                boxes.forEach(box => {
                    box.querySelector('.val').textContent = "-";
                    box.classList.remove('active');
                });
            }
        }

        document.getElementById('loadBtn').onclick = () => {
            const raw = document.getElementById('bulk').value;
            const nums = raw.split(/[ ,]+/).map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n>=0 && n<=36);
            history = [...history, ...nums];
            process();
            document.getElementById('bulk').value = '';
        };

        document.getElementById('clrBtn').onclick = () => {
            history = [];
            document.getElementById('seqText').textContent = "---";
            process();
        };

        window.onload = initPad;
    </script>
</body>
</html>
